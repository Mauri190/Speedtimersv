<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeedTimer Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1e293b;
            --accent-color: #f59e0b;
            --text-color: #ffffff;
            --panel-bg: rgba(15, 23, 42, 0.8);
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-color);
            overflow-y: auto;
            touch-action: manipulation;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: conic-gradient(
                #ff0000 0deg 90deg,
                #ffffff 90deg 180deg,
                #0000ff 180deg 270deg,
                #ffff00 270deg 360deg
            );
            border: 2px solid #333;
            border-radius: 4px;
            transform: rotate(-15deg);
        }
        
        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            font-size: 1.5rem;
            background: linear-gradient(to right, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .timer-display {
            font-family: 'Orbitron', monospace;
        }
        
        .scramble-display {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            background: var(--secondary-color);
            border-left: 3px solid var(--primary-color);
            white-space: normal; /* Ensure long scrambles wrap */
        }
        
        .timer-container {
            background: var(--panel-bg);
            border: 1px solid var(--primary-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        
        .timer-touch-area {
            background: var(--panel-bg);
            border: 1px solid var(--primary-color);
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .timer-touch-area:hover {
            background: rgba(15, 23, 42, 0.7);
        }
        
        .ready-state {
            animation: pulse 1.5s infinite;
            background: rgba(16, 185, 129, 0.1) !important;
            border-color: rgba(16, 185, 129, 0.5) !important;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .timer-red { color: #ef4444; }
        .timer-green { color: #10b981; }
        .timer-normal { color: white; }
        
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--primary-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        
        .btn-primary {
            background: var(--primary-color);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
        }
        
        .btn-danger { background: #ef4444; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3); }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.4); }
        
        .btn-training {
            background: var(--accent-color);
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3);
            transition: all 0.3s ease;
        }
        .btn-training:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.4);
        }
        
        .time-entry {
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(71, 85, 105, 0.5);
        }
        .time-entry:hover { background: rgba(30, 41, 59, 0.5) !important; }
        
        .dropdown-content {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--primary-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        .category-option:hover { background: rgba(59, 130, 246, 0.2) !important; }
        .active-category { background: var(--primary-color) !important; }
        
        .pb-alert { animation: bounce 0.5s infinite alternate, glow 1.5s infinite alternate; }
        @keyframes bounce {
            from { transform: translateY(0) translateX(-50%); }
            to { transform: translateY(-10px) translateX(-50%); }
        }
        @keyframes glow {
            from { box-shadow: 0 0 10px rgba(234, 179, 8, 0.5); }
            to { box-shadow: 0 0 20px rgba(234, 179, 8, 0.8); }
        }
        
        .compact-timer { font-size: 4.5rem; }
        @media (min-width: 768px) { .compact-timer { font-size: 6rem; } }
        
        .stats-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }
        .stats-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); }
        
        .best-time::after {
            content: '★'; position: absolute; right: -15px; top: 50%;
            transform: translateY(-50%); color: var(--accent-color); font-size: 1.2rem;
        }
        
        .inspection-timer {
            font-family: 'Orbitron', monospace; font-size: 2rem; color: #f59e0b;
            text-align: center; margin: 10px 0; transition: color 0.3s;
        }
        .inspection-warning { color: #ef4444; animation: pulse 1s infinite; }
        
        .settings-panel {
            position: fixed; top: 0; right: -400px; width: 380px; height: 100vh;
            background: var(--panel-bg); border-left: 1px solid var(--primary-color);
            z-index: 100; transition: right 0.3s ease; padding: 20px; overflow-y: auto;
        }
        .settings-panel.open { right: 0; }
        
        .settings-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 99; display: none;
        }
        .settings-overlay.active { display: block; }
        
        .color-picker { display: flex; gap: 10px; margin: 15px 0; }
        .color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-option.selected { border-color: white; }
        
        @media (max-width: 640px) {
            .compact-timer { font-size: 3.5rem; }
            .timer-touch-area { height: 100px; }
            .settings-panel { width: 100%; max-width: 320px; }
            .main-container { padding: 0.5rem; }
            .grid-cols-2, .grid-cols-3 { grid-template-columns: 1fr; } /* Ensure single column for stats on small screens */
            .stats-card { padding: 0.5rem; }
            .scramble-display { font-size: 0.9rem; padding: 0.5rem; }
            .timer-display { font-size: 3rem; }
            .btn-primary, .btn-danger, .btn-training { padding: 0.5rem 1rem; font-size: 0.8rem; }
        }
        
        @media screen and (min-width: 640px) and (max-height: 500px) and (orientation: landscape) {
            .main-container { padding: 0.5rem; max-width: 100%; }
            .grid-cols-1.lg\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
            .timer-container { padding: 0.5rem; }
            .compact-timer { font-size: 2.5rem; margin-bottom: 0.5rem; }
            .timer-touch-area { height: 60px; margin-bottom: 0.5rem; }
            .stats-card { padding: 0.25rem; }
            .stats-card .text-2xl { font-size: 1.25rem; }
        }
        .disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; }
    </style>
</head>
<body class="min-h-screen">
    <audio id="timer-start-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-click-1114.mp3" preload="auto"></audio>
    <audio id="timer-stop-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>
    <audio id="inspection-warning-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>
    
    <div class="settings-overlay" id="settings-overlay"></div>
    
    <div class="settings-panel" id="settings-panel">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">Ajustes</h2>
            <button id="close-settings" class="text-gray-400 hover:text-white" aria-label="Cerrar ajustes">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="mb-6">
            <h3 class="font-semibold mb-3">Tiempo de inspección</h3>
            <div class="flex flex-wrap gap-4">
                <label class="inline-flex items-center">
                    <input type="radio" name="inspection" value="0" class="mr-2" checked> Sin inspección
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="inspection" value="15" class="mr-2"> 15 segundos (WCA)
                </label>
            </div>
        </div>
        
        <div class="mb-6">
            <h3 class="font-semibold mb-3">Sonidos</h3>
            <div class="flex flex-wrap gap-4">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="sound-enabled" class="mr-2" checked> Habilitar sonidos
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" id="vibration-enabled" class="mr-2" checked> Habilitar vibración
                </label>
            </div>
        </div>
        
        <div class="mb-6">
            <h3 class="font-semibold mb-3">Color primario</h3>
            <div class="color-picker">
                <div class="color-option selected" data-color="#3b82f6" style="background-color: #3b82f6;" aria-label="Color primario Azul"></div>
                <div class="color-option" data-color="#10b981" style="background-color: #10b981;" aria-label="Color primario Verde"></div>
                <div class="color-option" data-color="#f59e0b" style="background-color: #f59e0b;" aria-label="Color primario Naranja"></div>
                <div class="color-option" data-color="#ef4444" style="background-color: #ef4444;" aria-label="Color primario Rojo"></div>
                <div class="color-option" data-color="#8b5cf6" style="background-color: #8b5cf6;" aria-label="Color primario Morado"></div>
            </div>
        </div>
        
        <div class="mb-6">
            <h3 class="font-semibold mb-3">Color de acento</h3>
            <div class="color-picker">
                <div class="color-option selected" data-accent="#f59e0b" style="background-color: #f59e0b;" aria-label="Color de acento Naranja"></div>
                <div class="color-option" data-accent="#3b82f6" style="background-color: #3b82f6;" aria-label="Color de acento Azul"></div>
                <div class="color-option" data-accent="#10b981" style="background-color: #10b981;" aria-label="Color de acento Verde"></div>
                <div class="color-option" data-accent="#ec4899" style="background-color: #ec4899;" aria-label="Color de acento Rosa"></div>
                <div class="color-option" data-accent="#6366f1" style="background-color: #6366f1;" aria-label="Color de acento Índigo"></div>
            </div>
        </div>
        
        <div class="mb-6">
            <h3 class="font-semibold mb-3">Tema oscuro/claro</h3>
            <div class="flex flex-wrap gap-4">
                <label class="inline-flex items-center">
                    <input type="radio" name="theme" value="dark" class="mr-2" checked> Oscuro
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="theme" value="light" class="mr-2"> Claro
                </label>
            </div>
        </div>
    </div>
    
    <div class="main-container container mx-auto px-4 py-6 max-w-6xl">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div class="logo-text">SpeedTimer</div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="dropdown relative">
                    <button class="px-4 py-2 bg-gray-800 rounded-lg font-medium hover:bg-gray-700 transition flex items-center shadow" id="category-btn" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-cube mr-2 text-blue-400"></i>
                        <span id="current-category-display">3x3x3</span>
                        <i class="fas fa-caret-down ml-2 text-blue-400"></i>
                    </button>
                    <div class="dropdown-content absolute right-0 mt-2 hidden w-48 z-10" id="category-dropdown" role="menu">
                        <a href="#" class="category-option active-category flex items-center px-4 py-2" data-category="333" role="menuitem"><i class="fas fa-cube mr-2"></i>3x3x3</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="222" role="menuitem"><i class="fas fa-th mr-2"></i>2x2x2</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="444" role="menuitem"><i class="fas fa-th-large mr-2"></i>4x4x4</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="555" role="menuitem"><i class="fas fa-th-large mr-2"></i>5x5x5</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="666" role="menuitem"><i class="fas fa-th-large mr-2"></i>6x6x6</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="777" role="menuitem"><i class="fas fa-th-large mr-2"></i>7x7x7</a>
                        <div class="border-t border-gray-700 my-1" role="separator"></div>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="333oh" role="menuitem"><i class="fas fa-hand-paper mr-2"></i>3x3x3 OH</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="333bf" role="menuitem"><i class="fas fa-blind mr-2"></i>3x3x3 BLD</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="333fm" role="menuitem"><i class="fas fa-pen-fancy mr-2"></i>3x3x3 FM</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="333mbf" role="menuitem"><i class="fas fa-brain mr-2"></i>3x3x3 MBLD</a>
                        <div class="border-t border-gray-700 my-1" role="separator"></div>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="minx" role="menuitem"><i class="fas fa-star mr-2"></i>Megaminx</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="pyram" role="menuitem"><i class="fas fa-play mr-2"></i>Pyraminx</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="skewb" role="menuitem"><i class="fas fa-gem mr-2"></i>Skewb</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="sq1" role="menuitem"><i class="fas fa-square mr-2"></i>Square-1 </a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="clock" role="menuitem"><i class="fas fa-clock mr-2"></i>Clock </a>
                        <div class="border-t border-gray-700 my-1" role="separator"></div>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="444bf" role="menuitem"><i class="fas fa-blind mr-2"></i>4x4x4 BLD</a>
                        <a href="#" class="category-option flex items-center px-4 py-2" data-category="555bf" role="menuitem"><i class="fas fa-blind mr-2"></i>5x5x5 BLD</a>
                    </div>
                </div>
                
                <div class="dropdown relative">
                    <button class="btn-training px-4 py-2 rounded-lg font-semibold transition flex items-center" id="training-btn" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-tachometer-alt mr-2"></i>Entrenamiento
                        <i class="fas fa-caret-down ml-2"></i>
                    </button>
                    <div class="dropdown-content absolute right-0 mt-2 hidden w-48 z-10" id="training-dropdown" role="menu">
                        <a href="entrenamiento.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-cube mr-2"></i>3x3x3</a>
                        <a href="entrenamiento2.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-th mr-2"></i>2x2x2</a>
                        <a href="entrenamiento4.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-th-large mr-2"></i>4x4x4</a>
                        <a href="entrenamiento5.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-th-large mr-2"></i>5x5x5</a>
                        <div class="border-t border-gray-700 my-1" role="separator"></div>
                        <a href="entrenamiento_oh.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-hand-paper mr-2"></i>3x3x3 OH </a>
                        <a href="entrenamiento_oh.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-blind mr-2"></i>3x3x3 BLD </a>
                        <div class="border-t border-gray-700 my-1" role="separator"></div>
                        <a href="entrenamiento_mega.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-star mr-2"></i>Megaminx </a>
                        <a href="entrenamiento_pyra.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-play mr-2"></i>Pyraminx</a>
                        <a href="entrenamiento_skewb.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-gem mr-2"></i>Skewb</a>
                        <a href="entrenamiento_sq-1.html" class="flex items-center px-4 py-2" role="menuitem"><i class="fas fa-square mr-2"></i>Square-1</a>
                    </div>
                </div>
                
                <button id="fullscreen-btn" class="p-2 rounded-lg hover:bg-gray-700 transition" aria-label="Activar pantalla completa">
                    <i id="fullscreen-icon" class="fas fa-expand text-xl"></i>
                </button>
                <button id="settings-btn" class="p-2 rounded-lg hover:bg-gray-700 transition" aria-label="Abrir ajustes" aria-expanded="false">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 pb-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="timer-container panel p-6 flex flex-col items-center">
                    <div class="timer-display compact-timer font-bold mb-6 text-center timer-red" id="timer" aria-live="polite">0.00</div>
                    <div class="inspection-timer hidden" id="inspection-timer" aria-live="polite">15</div>
                    
                    <div class="w-full h-28 timer-touch-area rounded-xl flex items-center justify-center mb-6 cursor-pointer transition-all"
                         id="timer-touch-area" role="button" tabindex="0">
                        <div class="text-sm md:text-base text-gray-300 text-center px-4" id="timer-instruction">
                            Presiona la barra espaciadora<br>o toca aquí para comenzar
                        </div>
                    </div>
                    
                    <div class="flex gap-3 w-full justify-center">
                        <button class="btn-danger px-5 py-2.5 rounded-lg font-semibold transition text-sm flex items-center" id="reset-btn">
                            <i class="fas fa-undo mr-2"></i>Reiniciar
                        </button>
                        <button class="btn-primary px-5 py-2.5 rounded-lg font-semibold transition text-sm flex items-center" id="new-scramble-btn">
                            <i class="fas fa-random mr-2"></i>Nuevo Scramble
                        </button>
                    </div>
                </div>
                
                <div class="panel p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-blue-400">
                            <i class="fas fa-history mr-2"></i>Historial de Tiempos
                        </h3>
                        <div class="flex gap-4">
                            <button id="reset-session-btn" class="text-xs text-yellow-400 hover:text-yellow-300 flex items-center">
                                <i class="fas fa-redo mr-1"></i>Reiniciar Sesión
                            </button>
                            <button id="clear-times" class="text-xs text-red-400 hover:text-red-300 flex items-center">
                                <i class="fas fa-trash mr-1"></i>Borrar
                            </button>
                        </div>
                    </div>
                    <div class="scrollable-history max-h-64 overflow-y-auto pr-2" id="times-list" aria-live="polite">
                        <div class="text-center text-gray-400 py-6">
                            <i class="fas fa-clock text-2xl mb-2"></i>
                            <div>No hay tiempos registrados</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-6">
                <div class="panel p-5">
                    <h3 class="text-lg font-semibold text-blue-400 mb-4 text-center">
                        <i class="fas fa-chart-bar mr-2"></i>Estadísticas
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="stats-card">
                            <div class="text-xs text-gray-400 uppercase tracking-wider">Actual</div>
                            <div class="text-2xl font-bold mt-1" id="current-time" aria-live="polite">-</div>
                        </div>
                        <div class="stats-card best-time">
                            <div class="text-xs text-gray-400 uppercase tracking-wider">Mejor</div>
                            <div class="text-2xl font-bold mt-1" id="best-time" aria-live="polite">-</div>
                        </div>
                        <div class="stats-card">
                            <div class="text-xs text-gray-400 uppercase tracking-wider">Avg de 5</div>
                            <div class="text-2xl font-bold mt-1" id="avg5-time" aria-live="polite">-</div>
                        </div>
                        <div class="stats-card">
                            <div class="text-xs text-gray-400 uppercase tracking-wider">Avg de 12</div>
                            <div class="text-2xl font-bold mt-1" id="avg12-time" aria-live="polite">-</div>
                        </div>
                        <div class="stats-card">
                            <div class="text-xs text-gray-400 uppercase tracking-wider">Mejor (Sesión)</div>
                            <div class="text-2xl font-bold mt-1" id="session-best-time" aria-live="polite">-</div>
                        </div>
                        <div class="stats-card">
                            <div class="text-xs text-gray-400 uppercase tracking-wider">Avg de 5 (Sesión)</div>
                            <div class="text-2xl font-bold mt-1" id="session-avg5-time" aria-live="polite">-</div>
                        </div>
                         <div class="stats-card">
                            <div class="text-xs text-gray-400 uppercase tracking-wider">Solves (Sesión)</div>
                            <div class="text-2xl font-bold mt-1" id="session-solve-count" aria-live="polite">0</div>
                        </div>
                        <div class="stats-card">
                            <div class="text-xs text-gray-400 uppercase tracking-wider">Desv. Estándar</div>
                            <div class="text-2xl font-bold mt-1" id="std-dev-time" aria-live="polite">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel p-5">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-blue-400">
                            <i class="fas fa-random mr-2"></i>Scramble
                        </h3>
                        <span class="text-xs bg-gray-700 text-blue-400 px-2 py-1 rounded-full" id="current-category">3x3x3</span>
                    </div>
                    <div class="scramble-display p-3 rounded-lg text-center text-sm md:text-base leading-relaxed" id="scramble" aria-live="polite"></div>
                </div>

                <div class="panel p-5">
                    <h3 class="text-lg font-semibold text-blue-400 mb-3 text-center">
                        <i class="fas fa-chart-line mr-2"></i>Progreso
                    </h3>
                    <div class="h-48">
                        <canvas id="times-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- GLOBAL VARIABLES ---
    let timerInterval;
    let inspectionInterval;
    let startTime;
    let running = false;
    let ready = false;
    let inspecting = false;
    let times = JSON.parse(localStorage.getItem('speedcube-times')) || [];
    let sessionTimes = []; // For session-specific stats
    let currentCategory = '333';
    let currentScramble = '';
    let holdingTimer = false;
    let timesChart = null;

    // --- SETTINGS (with defaults from localStorage or initial values) ---
    let inspectionTime = localStorage.getItem('inspection-time') || '0';
    let primaryColor = localStorage.getItem('primary-color') || '#3b82f6';
    let accentColor = localStorage.getItem('accent-color') || '#f59e0b';
    let theme = localStorage.getItem('theme') || 'dark';
    let soundEnabled = localStorage.getItem('sound-enabled') !== 'false';
    let vibrationEnabled = localStorage.getItem('vibration-enabled') !== 'false';

    // --- DOM ELEMENTS ---
    const timerDisplay = document.getElementById('timer');
    const inspectionTimerDisplay = document.getElementById('inspection-timer');
    const timerTouchArea = document.getElementById('timer-touch-area');
    const timerInstruction = document.getElementById('timer-instruction');
    const scrambleDisplay = document.getElementById('scramble');
    const resetBtn = document.getElementById('reset-btn');
    const newScrambleBtn = document.getElementById('new-scramble-btn');

    // Stat Displays
    const currentTimeDisplay = document.getElementById('current-time');
    const bestTimeDisplay = document.getElementById('best-time');
    const avg5TimeDisplay = document.getElementById('avg5-time');
    const avg12TimeDisplay = document.getElementById('avg12-time');
    const sessionBestTimeDisplay = document.getElementById('session-best-time');
    const sessionAvg5TimeDisplay = document.getElementById('session-avg5-time');
    const sessionSolveCountDisplay = document.getElementById('session-solve-count');
    const stdDevTimeDisplay = document.getElementById('std-dev-time');

    const timesList = document.getElementById('times-list');
    const clearTimesBtn = document.getElementById('clear-times');
    const resetSessionBtn = document.getElementById('reset-session-btn');

    // Category Elements
    const categoryOptionElements = document.querySelectorAll('.category-option');
    const currentCategorySpan = document.getElementById('current-category');
    const currentCategoryDisplayMain = document.getElementById('current-category-display');
    const categoryDropdown = document.getElementById('category-dropdown');
    const categoryBtn = document.getElementById('category-btn');

    // Training Elements
    const trainingBtn = document.getElementById('training-btn');
    const trainingDropdown = document.getElementById('training-dropdown');

    // Settings Elements
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const settingsOverlay = document.getElementById('settings-overlay');
    const closeSettingsBtn = document.getElementById('close-settings');
    const colorOptionElements = document.querySelectorAll('.color-option');
    const soundToggle = document.getElementById('sound-enabled');
    const vibrationToggle = document.getElementById('vibration-enabled');

    // Fullscreen Elements
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const fullscreenIcon = document.getElementById('fullscreen-icon');

    // Audio elements
    const timerStartSound = document.getElementById('timer-start-sound');
    const timerStopSound = document.getElementById('timer-stop-sound');
    const inspectionWarningSound = document.getElementById('inspection-warning-sound');

    // --- HELPER FUNCTION FOR TIME FORMATTING ---
    /**
     * Formats time in seconds to a display string (MM:SS.ss or SS.ss).
     * @param {number} timeInSeconds - The time in seconds.
     * @param {boolean} showMilliseconds - Whether to show milliseconds. Defaults to true.
     * @returns {string} Formatted time string.
     */
    function formatTimeDisplay(timeInSeconds, showMilliseconds = true) {
        if (isNaN(timeInSeconds) || timeInSeconds === null) return '-';
        if (timeInSeconds === Infinity) return 'DNF';

        const minutes = Math.floor(timeInSeconds / 60);
        const seconds = timeInSeconds % 60;

        let formattedTime;

        if (minutes > 0) {
            formattedTime = `${minutes}:${seconds < 10 ? '0' : ''}`;
        } else {
            formattedTime = "";
        }

        if (showMilliseconds) {
            formattedTime += seconds.toFixed(2);
        } else {
            formattedTime += Math.floor(seconds);
        }
        
        // Adjust for when minutes > 0, seconds part needs to be handled carefully with toFixed
        if (minutes > 0) {
            if (showMilliseconds) {
                 formattedTime = `${minutes}:${seconds < 10 ? '0' : ''}${seconds.toFixed(2)}`;
            } else {
                 formattedTime = `${minutes}:${seconds < 10 ? '0' : ''}${Math.floor(seconds)}`;
            }
        } else {
            if (showMilliseconds) {
                formattedTime = seconds.toFixed(2);
            } else {
                formattedTime = Math.floor(seconds).toString();
            }
        }
        return formattedTime;
    }


    // --- INITIALIZATION ---
    applyTheme();
    updateColors();
    const inspectionRadio = document.querySelector(`input[name="inspection"][value="${inspectionTime}"]`);
    if (inspectionRadio) inspectionRadio.checked = true;
    const themeRadio = document.querySelector(`input[name="theme"][value="${theme}"]`);
    if (themeRadio) themeRadio.checked = true;
    soundToggle.checked = soundEnabled;
    vibrationToggle.checked = vibrationEnabled;

    document.querySelectorAll('.color-option[data-color]').forEach(opt => {
        if (opt.getAttribute('data-color') === primaryColor) opt.classList.add('selected');
        else opt.classList.remove('selected');
    });
    document.querySelectorAll('.color-option[data-accent]').forEach(opt => {
        if (opt.getAttribute('data-accent') === accentColor) opt.classList.add('selected');
        else opt.classList.remove('selected');
    });

    generateNewScramble(currentCategory);
    updateStats(); // This will also call updateSessionStats
    renderTimesList();
    initTimesChart();

    // --- EVENT LISTENERS ---
    // Timer Interaction
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('keyup', handleKeyUp);
    timerTouchArea.addEventListener('mousedown', handleTouchStart);
    timerTouchArea.addEventListener('touchstart', handleTouchStart, { passive: false });
    timerTouchArea.addEventListener('mouseup', handleTouchEnd);
    timerTouchArea.addEventListener('touchend', handleTouchEnd, { passive: false });

    // Buttons
    resetBtn.addEventListener('click', resetTimer);
    newScrambleBtn.addEventListener('click', () => generateNewScramble(currentCategory));
    clearTimesBtn.addEventListener('click', clearAllTimes);
    resetSessionBtn.addEventListener('click', resetSession);
    fullscreenBtn.addEventListener('click', toggleFullScreen);
    document.addEventListener('fullscreenchange', handleFullscreenChange);

    // Settings Panel
    settingsBtn.addEventListener('click', toggleSettings);
    closeSettingsBtn.addEventListener('click', toggleSettings);
    settingsOverlay.addEventListener('click', toggleSettings);

    // Times List Interaction (Penalties, Deletion, Scramble View)
    timesList.addEventListener('click', function(e) {
        const penaltyBtn = e.target.closest('.penalty-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        const timeEntryDiv = e.target.closest('.time-entry');

        if (penaltyBtn) {
            e.stopPropagation();
            const index = parseInt(penaltyBtn.getAttribute('data-index'));
            const penaltyType = penaltyBtn.getAttribute('data-penalty');
            applyPenalty(index, penaltyType);
        } else if (deleteBtn) {
            e.stopPropagation();
            const index = parseInt(deleteBtn.getAttribute('data-index'));
            deleteTimeEntry(index);
        } else if (timeEntryDiv) {
            const renderedIndex = Array.from(timesList.querySelectorAll('.time-entry')).indexOf(timeEntryDiv);
            const categoryTimes = times.filter(t => t.category === currentCategory);
            if (categoryTimes[renderedIndex]) {
                showScrambleForTime(categoryTimes[renderedIndex].scramble, categoryTimes[renderedIndex]);
            }
        }
    });

    // Settings Controls
    document.querySelectorAll('input[name="inspection"]').forEach(radio => {
        radio.addEventListener('change', function() {
            inspectionTime = this.value;
            localStorage.setItem('inspection-time', inspectionTime);
        });
    });

    document.querySelectorAll('input[name="theme"]').forEach(radio => {
        radio.addEventListener('change', function() {
            theme = this.value;
            localStorage.setItem('theme', theme);
            applyTheme();
        });
    });

    soundToggle.addEventListener('change', function() {
        soundEnabled = this.checked;
        localStorage.setItem('sound-enabled', soundEnabled);
    });

    vibrationToggle.addEventListener('change', function() {
        vibrationEnabled = this.checked;
        localStorage.setItem('vibration-enabled', vibrationEnabled);
    });

    colorOptionElements.forEach(option => {
        option.addEventListener('click', function() {
            const h3Text = this.parentElement.previousElementSibling.textContent;
            if (h3Text.includes('primario')) {
                primaryColor = this.getAttribute('data-color');
                localStorage.setItem('primary-color', primaryColor);
            } else if (h3Text.includes('acento')) {
                accentColor = this.getAttribute('data-accent');
                localStorage.setItem('accent-color', accentColor);
            }

            this.parentElement.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');

            updateColors();
            if (timesChart) updateChartColors();
        });
    });

    // Dropdown Menus (Category & Training)
    categoryBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleDropdown(categoryDropdown);
        hideDropdown(trainingDropdown);
        categoryBtn.setAttribute('aria-expanded', categoryDropdown.style.display === 'block');
    });

    trainingBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleDropdown(trainingDropdown);
        hideDropdown(categoryDropdown);
        trainingBtn.setAttribute('aria-expanded', trainingDropdown.style.display === 'block');
    });

    document.addEventListener('click', function(e) { // Hide dropdowns if clicked outside
        if (!categoryDropdown.contains(e.target) && e.target !== categoryBtn) {
            hideDropdown(categoryDropdown);
            categoryBtn.setAttribute('aria-expanded', 'false');
        }
        if (!trainingDropdown.contains(e.target) && e.target !== trainingBtn) {
            hideDropdown(trainingDropdown);
            trainingBtn.setAttribute('aria-expanded', 'false');
        }
    });

    categoryOptionElements.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            categoryOptionElements.forEach(o => o.classList.remove('active-category'));
            this.classList.add('active-category');

            currentCategory = this.dataset.category;
            currentCategorySpan.textContent = getCategoryName(currentCategory);
            currentCategoryDisplayMain.textContent = getCategoryName(currentCategory);

            hideDropdown(categoryDropdown);
            categoryBtn.setAttribute('aria-expanded', 'false');

            resetSession(); // Reset session stats on category change
            generateNewScramble(currentCategory);
            updateStats();
            renderTimesList();
            updateChartData();
        });
    });

    const trainingOptionElements = document.querySelectorAll('#training-dropdown a:not(.disabled)');
    trainingOptionElements.forEach(option => {
        option.addEventListener('click', function() {
            hideDropdown(trainingDropdown);
            trainingBtn.setAttribute('aria-expanded', 'false');
        });
    });

    // --- UI FUNCTIONS (Dropdowns, Settings Panel, Colors, Theme) ---
    function toggleDropdown(dropdownElement) {
        dropdownElement.style.display = dropdownElement.style.display === 'block' ? 'none' : 'block';
    }

    function hideDropdown(dropdownElement) {
        dropdownElement.style.display = 'none';
    }

    function toggleSettings() {
        settingsPanel.classList.toggle('open');
        settingsOverlay.classList.toggle('active');
        settingsBtn.setAttribute('aria-expanded', settingsPanel.classList.contains('open'));
    }

    function updateColors() {
        document.documentElement.style.setProperty('--primary-color', primaryColor);
        document.documentElement.style.setProperty('--accent-color', accentColor);
        document.querySelectorAll('.btn-primary').forEach(el => el.style.backgroundColor = primaryColor);
        document.querySelectorAll('.text-blue-400').forEach(el => el.style.color = primaryColor);
    }

    function hexToRgba(hex, alpha) {
        if (!hex || typeof hex !== 'string' || !hex.startsWith('#')) return `rgba(0,0,0,${alpha})`;
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function applyTheme() {
        if (theme === 'light') {
            document.documentElement.style.setProperty('--panel-bg', 'rgba(241, 245, 249, 0.9)');
            document.documentElement.style.setProperty('--secondary-color', '#e2e8f0');
            document.documentElement.style.setProperty('--text-color', '#0f172a');
            document.body.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)';
        } else {
            document.documentElement.style.setProperty('--panel-bg', 'rgba(15, 23, 42, 0.8)');
            document.documentElement.style.setProperty('--secondary-color', '#1e293b');
            document.documentElement.style.setProperty('--text-color', '#ffffff');
            document.body.style.background = 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)';
        }
        if (timesChart) updateChartColors();
    }

    // --- FULLSCREEN FUNCTIONS ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.warn(`Fullscreen request error: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    function handleFullscreenChange() {
        if (document.fullscreenElement) {
            fullscreenIcon.classList.remove('fa-expand');
            fullscreenIcon.classList.add('fa-compress');
            fullscreenBtn.setAttribute('aria-label', 'Desactivar pantalla completa');
        } else {
            fullscreenIcon.classList.remove('fa-compress');
            fullscreenIcon.classList.add('fa-expand');
            fullscreenBtn.setAttribute('aria-label', 'Activar pantalla completa');
        }
    }

    // --- AUDIO & VIBRATION ---
    function playSound(audioElement) {
        if (soundEnabled && audioElement) {
            audioElement.currentTime = 0;
            audioElement.play().catch(e => console.warn('Audio play error:', e));
        }
    }

    function vibrate(pattern) {
        if (vibrationEnabled && 'vibrate' in navigator) {
            try { navigator.vibrate(pattern); }
            catch (e) { console.warn("Vibration error:", e); }
        }
    }

    // --- TIMER INPUT HANDLING (Corrected) ---
    /**
     * Handles keydown events, primarily for Spacebar to prepare timer or inspection.
     */
    function handleKeyDown(e) {
        if (settingsPanel.classList.contains('open')) return;

        if (e.code === 'Space' && e.target.matches('input[type="text"], textarea')) {
             return;
        }
        if (e.code !== 'Space' && e.target.matches('input:not([type="button"]):not([type="submit"]):not([type="reset"]), textarea, select')) {
            return;
        }

        if (e.code === 'Space') {
            e.preventDefault();
            if (holdingTimer) return;

            if (!running && !ready && !inspecting) {
                if (inspectionTime === '15') {
                    startInspection();
                } else {
                    prepareTimer();
                }
            }
            holdingTimer = true;
        }
    }

    /**
     * Handles keyup events, primarily for Spacebar to start/stop timer.
     */
    function handleKeyUp(e) {
        if (settingsPanel.classList.contains('open')) return;

        if (e.code === 'Space' && e.target.matches('input[type="text"], textarea')) {
             return;
        }
        if (e.code !== 'Space' && e.target.matches('input:not([type="button"]):not([type="submit"]):not([type="reset"]), textarea, select')) {
            return;
        }

        if (e.code === 'Space') {
            e.preventDefault();

            if (!holdingTimer && !running && !ready && !inspecting) {
                holdingTimer = false;
                return;
            }

            if (running) {
                stopTimer();
            } else if (ready && !inspecting) {
                startTimer();
            } else if (inspecting) {
                stopInspection(false, true);
            }
            holdingTimer = false;
        }
    }

    /**
     * Attached when timer starts: Stops timer on any non-Space key press during a solve.
     */
    function stopTimerOnAnyKeyDuringSolve(e) {
        if (e.target.matches('input[type="text"], input[type="number"], input[type="search"], textarea, select') ||
            (e.target.matches('input[type="radio"], input[type="checkbox"]') && e.code !== 'Space' && e.code !== 'Enter') ) {
            return;
        }

        if (running && e.code !== 'Space') {
            e.preventDefault();
            stopTimer();
        }
    }

    function handleTouchStart(e) {
        if (settingsPanel.classList.contains('open')) return;
        e.preventDefault();
        if (holdingTimer) return;

        if (!running && !ready && !inspecting) {
            if (inspectionTime === '15') startInspection();
            else prepareTimer();
        }
        holdingTimer = true;
    }

    function handleTouchEnd(e) {
        if (settingsPanel.classList.contains('open')) return;
        e.preventDefault();
        if (!holdingTimer && !running && !inspecting && !ready) {
             holdingTimer = false;
             return;
        }

        if (running) {
            stopTimer();
        } else if (ready && !inspecting) {
            startTimer();
        } else if (inspecting) {
             stopInspection(false, true);
        }
        holdingTimer = false;
    }

    // --- TIMER CORE LOGIC (Inspection, Start, Stop, Reset) ---
    function startInspection() {
        inspecting = true;
        let timeLeft = 15;
        inspectionTimerDisplay.textContent = timeLeft;
        inspectionTimerDisplay.classList.remove('hidden');
        timerInstruction.textContent = 'Inspección en curso... Suelta para iniciar';
        timerTouchArea.classList.add('ready-state');
        timerDisplay.classList.remove('timer-red', 'timer-normal');
        timerDisplay.classList.add('timer-green');
        timerDisplay.textContent = formatTimeDisplay(0); // '0.00'

        inspectionInterval = setInterval(() => {
            timeLeft--;
            inspectionTimerDisplay.textContent = timeLeft;

            if (timeLeft === 8 || timeLeft === 3) {
                inspectionTimerDisplay.classList.add('inspection-warning');
                playSound(inspectionWarningSound);
                vibrate(100);
                setTimeout(() => inspectionTimerDisplay.classList.remove('inspection-warning'), 500);
            }

            if (timeLeft <= 0) stopInspection(true);
        }, 1000);
    }

    function stopInspection(timeout = false, userInitiatedStop = false) {
        clearInterval(inspectionInterval);
        inspectionTimerDisplay.classList.remove('inspection-warning');

        if (timeout) {
            inspecting = false;
            timerInstruction.textContent = '¡Tiempo de inspección agotado!';
            prepareTimer(true); // Prepare with +2 indication
            if (holdingTimer || userInitiatedStop) startTimer(true); // Start with +2 penalty if user was holding
            else {
                timerDisplay.textContent = "+2.00"; // Show +2 if not started and user wasn't holding
                timerDisplay.classList.add('timer-red');
            }
        } else if (userInitiatedStop) {
             inspecting = false;
             inspectionTimerDisplay.classList.add('hidden');
             if (!ready) prepareTimer();
             startTimer();
        }
    }

    function prepareTimer(isPenaltyFromInspection = false) {
        ready = true;
        timerDisplay.classList.remove('timer-red', 'timer-normal');
        timerDisplay.classList.add('timer-green');
        timerDisplay.textContent = isPenaltyFromInspection ? '+2.00' : formatTimeDisplay(0); // '0.00'
        timerTouchArea.classList.add('ready-state');
        timerInstruction.textContent = 'Mantén presionado... Suelta para iniciar';
    }

    function startTimer(applyPenaltyFromInspection = false) {
        if (!ready && !applyPenaltyFromInspection) return;

        running = true;
        ready = false;
        inspecting = false;
        clearInterval(inspectionInterval);
        inspectionTimerDisplay.classList.add('hidden');

        startTime = Date.now();

        if (applyPenaltyFromInspection) {
            localStorage.setItem('timer_start_penalty_flag', 'true');
        } else {
            localStorage.removeItem('timer_start_penalty_flag');
        }

        timerInterval = setInterval(updateTimerDisplay, 10);
        timerTouchArea.classList.remove('ready-state');
        timerDisplay.classList.remove('timer-green');
        timerDisplay.classList.add('timer-normal');
        timerDisplay.textContent = formatTimeDisplay(0); // Always start display from 0.00

        timerInstruction.textContent = 'Presiona cualquier tecla o toca para detener';

        playSound(timerStartSound);
        vibrate(50);

        document.addEventListener('keydown', stopTimerOnAnyKeyDuringSolve);
    }


    function stopTimer() {
        if (!running) return;
        running = false;
        clearInterval(timerInterval);
        document.removeEventListener('keydown', stopTimerOnAnyKeyDuringSolve);

        const endTime = Date.now();
        let elapsedTimeMs = endTime - startTime;

        let penaltyType;
        if (localStorage.getItem('timer_start_penalty_flag') === 'true') {
            penaltyType = '+2';
            localStorage.removeItem('timer_start_penalty_flag');
        }

        const finalTimeSeconds = elapsedTimeMs / 1000;

        const timeEntry = {
            time: finalTimeSeconds,
            scramble: currentScramble,
            date: new Date().toISOString(),
            category: currentCategory,
            penalty: penaltyType
        };

        const categoryTimesForPB = times.filter(t => t.category === currentCategory && t.penalty !== 'DNF');
        const validRawTimesForPB = categoryTimesForPB.map(t => t.penalty === '+2' ? t.time + 2 : t.time);

        let recordedTimeForPB = finalTimeSeconds;
        if(penaltyType === '+2') recordedTimeForPB +=2;

        if (penaltyType !== 'DNF' && (validRawTimesForPB.length === 0 || recordedTimeForPB < Math.min(...validRawTimesForPB))) {
             showPBAlert(recordedTimeForPB);
        }

        times.unshift(timeEntry);
        sessionTimes.unshift(timeEntry);
        if (times.length > 1000) times = times.slice(0, 1000);

        localStorage.setItem('speedcube-times', JSON.stringify(times));

        updateStats();
        renderTimesList();
        updateChartData();

        generateNewScramble(currentCategory);

        timerInstruction.textContent = 'Presiona la barra espaciadora\no toca aquí para comenzar';
        timerDisplay.classList.remove('timer-normal', 'timer-green');
        timerDisplay.classList.add('timer-red');
        timerDisplay.textContent = formatTimeWithPenalty(finalTimeSeconds, penaltyType);

        playSound(timerStopSound);
        vibrate(100);
    }


    function resetTimer() {
        running = false;
        ready = false;
        inspecting = false;
        holdingTimer = false;
        clearInterval(timerInterval);
        clearInterval(inspectionInterval);
        timerDisplay.textContent = formatTimeDisplay(0); // '0.00'
        timerDisplay.classList.remove('timer-green', 'timer-normal');
        timerDisplay.classList.add('timer-red');
        timerTouchArea.classList.remove('ready-state');
        inspectionTimerDisplay.classList.add('hidden');
        inspectionTimerDisplay.classList.remove('inspection-warning');
        timerInstruction.textContent = 'Presiona la barra espaciadora\no toca aquí para comenzar';
        document.removeEventListener('keydown', stopTimerOnAnyKeyDuringSolve);
        localStorage.removeItem('timer_start_penalty_flag');
    }

    function updateTimerDisplay() {
        const elapsedTime = (Date.now() - startTime) / 1000;
        timerDisplay.textContent = formatTimeDisplay(elapsedTime); // Use new formatter
    }

    // --- SCRAMBLE GENERATION ---
       function generateScramble(category) {
            if (category === '333' || !category) return generate3x3Scramble();
            if (category === '222') return generate2x2Scramble();
            if (category === '444') return generate4x4Scramble();
            if (category === '555') return generate5x5Scramble();
            if (category === '666') return generate6x6Scramble();
            if (category === '777') return generate7x7Scramble();
            if (category === '333bf' || category === '333oh') return generate3x3Scramble();
            if (category === '333fm') return "Fewest Moves - Utiliza generador oficial";
            if (category === 'clock') return generateClockScramble();
            if (category === 'minx') return generateMegaminxScramble();
            if (category === 'pyram') return generatePyraminxScramble();
            if (category === 'skewb') return generateSkewbScramble();
            if (category === 'sq1') return generateSquare1Scramble();
            if (category === '444bf' || category === '555bf') return "BLD Grande - Utiliza generador oficial";
            if (category === '333mbf') return "MultiBLD - Utiliza generador oficial";
            return `Scramble para ${getCategoryName(category)} no implementado.`;
        }

        function generate3x3Scramble() {
            const faces = ['U', 'D', 'F', 'B', 'R', 'L'];
            const modifiers = ['', "'", '2'];
            const scramble = [];
            let lastFace = '';
            let secondLastFace = '';

            for (let i = 0; i < 20; i++) {
                let face;
                do {
                    face = faces[Math.floor(Math.random() * faces.length)];
                } while (
                    face === lastFace ||
                    (face === secondLastFace && isOppositeFace(face, lastFace))
                );
                const modifier = modifiers[Math.floor(Math.random() * modifiers.length)];
                scramble.push(face + modifier);
                secondLastFace = lastFace;
                lastFace = face;
            }
            return scramble.join(' ');
        }

        function isOppositeFace(face1, face2) {
            const oppositePairs = { 'U': 'D', 'D': 'U', 'F': 'B', 'B': 'F', 'R': 'L', 'L': 'R' };
            return oppositePairs[face1] === face2;
        }

        function generate2x2Scramble() {
            const faces = ['R', 'U', 'F'];
            const modifiers = ['', "'", '2'];
            const scrambleLength = Math.floor(Math.random() * 3) + 9;
            const scrambleArr = [];
            let lastFace = '';
            for (let i = 0; i < scrambleLength; i++) {
                let face;
                do {
                    face = faces[Math.floor(Math.random() * faces.length)];
                } while (face === lastFace);
                const modifier = modifiers[Math.floor(Math.random() * modifiers.length)];
                scrambleArr.push(face + modifier);
                lastFace = face;
            }
            return scrambleArr.join(' ');
        }

        function getAxis(faceInitial) {
            let face = faceInitial;
            if (face.length > 1 && (face.endsWith('w') || face.endsWith('W'))) {
                face = face.charAt(face.length - 2);
                 if (face.match(/[0-9]/)) {
                    face = face.charAt(0);
                }
            } else if (face.length > 0) {
                 face = face.charAt(0);
            }

            if (['U', 'D', 'E'].includes(face.toUpperCase())) return 'Y';
            if (['R', 'L', 'M'].includes(face.toUpperCase())) return 'X';
            if (['F', 'B', 'S'].includes(face.toUpperCase())) return 'Z';
            return '';
        }

        function generateNxNScramble(size, length) {
            const faces = ['U', 'D', 'F', 'B', 'R', 'L'];
            const modifiers = ['', "'", '2'];

            let allPossibleBaseMoves = [...faces];
            if (size >= 4) {
                allPossibleBaseMoves.push(...faces.map(f => f + 'w'));
                 if (size >= 5) {
                    allPossibleBaseMoves.push(...faces.map(f => '2' + f + 'w'));
                }
            }
            if (size >= 6) {
                allPossibleBaseMoves.push(...faces.map(f => '3' + f + 'w'));
                 if (size === 7) {
                    allPossibleBaseMoves.push(...faces.map(f => '4' + f + 'w'));
                }
            }

            const scrambleArr = [];
            let lastMoveAxis = '';
            let lastMoveBaseFace = '';


            for (let i = 0; i < length; i++) {
                let currentMoveBase, currentMoveAxis, currentMoveBaseFace;
                do {
                    currentMoveBase = allPossibleBaseMoves[Math.floor(Math.random() * allPossibleBaseMoves.length)];

                    if (currentMoveBase.length > 1 && currentMoveBase.match(/^\d/)) {
                        currentMoveBaseFace = currentMoveBase.charAt(1);
                    } else if (currentMoveBase.length > 0) {
                        currentMoveBaseFace = currentMoveBase.charAt(0);
                    } else {
                        currentMoveBaseFace = '';
                    }
                    currentMoveAxis = getAxis(currentMoveBaseFace);

                } while (currentMoveAxis === lastMoveAxis ||
                         (currentMoveAxis !== '' && currentMoveBaseFace === lastMoveBaseFace) ||
                         currentMoveAxis === '');

                const modifier = modifiers[Math.floor(Math.random() * modifiers.length)];
                scrambleArr.push(currentMoveBase + modifier);
                lastMoveAxis = currentMoveAxis;
                lastMoveBaseFace = currentMoveBaseFace;
            }
            return scrambleArr.join(' ');
        }

        function generate4x4Scramble() { return generateNxNScramble(4, 40 + Math.floor(Math.random() * 5)); }
        function generate5x5Scramble() { return generateNxNScramble(5, 60 + Math.floor(Math.random() * 5)); }
        function generate6x6Scramble() { return generateNxNScramble(6, 80 + Math.floor(Math.random() * 5)); }
        function generate7x7Scramble() { return generateNxNScramble(7, 100 + Math.floor(Math.random()* 5));}

        function generateClockScramble() {
            const dials = ["UR", "DR", "DL", "UL", "U", "R", "D", "L", "ALL"];
            const turns = ["1+", "2+", "3+", "4+", "5+", "6+", "1-", "2-", "3-", "4-", "5-", "6-"];
            let scrambleArr = [];
            for (let i = 0; i < 9; i++) {
                scrambleArr.push(dials[i] + turns[Math.floor(Math.random() * turns.length)]);
            }
            scrambleArr.push("y2");
            for (let i = 0; i < 4; i++) {
                 scrambleArr.push(dials[i+4] + turns[Math.floor(Math.random() * turns.length)]);
            }
            const finalPins = ["UR", "DR", "DL", "UL"];
            finalPins.forEach(pin => {
                if (Math.random() > 0.5) {
                    scrambleArr.push(pin);
                }
            });
            return scrambleArr.join(" ");
        }

        function generateMegaminxScramble() {
            const rMoves = ["R++", "R--"];
            const dMoves = ["D++", "D--"];
            const uMoves = ["U", "U'"];
            let rdSequence = [];
            rdSequence.push(rMoves[Math.floor(Math.random() * rMoves.length)]);
            for (let i = 0; i < 34; i++) {
                rdSequence.push(dMoves[Math.floor(Math.random() * dMoves.length)]);
                rdSequence.push(rMoves[Math.floor(Math.random() * rMoves.length)]);
            }
            const finalUMove = uMoves[Math.floor(Math.random() * uMoves.length)];

            let fullSequence = [...rdSequence, finalUMove];

            let resultScrambleLines = [];
            for (let i = 0; i < fullSequence.length; i += 10) {
                resultScrambleLines.push(fullSequence.slice(i, i + 10).join(" "));
            }
            return resultScrambleLines.join("\n");
        }

        function generatePyraminxScramble() {
            const moves = ["U", "L", "R", "B"];
            const tips = ["u", "l", "r", "b"];
            const modifiers = ["", "'"];
            let scrambleArr = [];
            let lastMove = '';
            const numMainMoves = Math.floor(Math.random() * 3) + 7;
            for (let i = 0; i < numMainMoves; i++) {
                let move;
                do { move = moves[Math.floor(Math.random() * moves.length)]; } while (move === lastMove);
                scrambleArr.push(move + modifiers[Math.floor(Math.random() * modifiers.length)]);
                lastMove = move;
            }
            const numTipMoves = Math.floor(Math.random() * 5);
            let availableTips = [...tips];
            for (let i = 0; i < numTipMoves; i++) {
                if (availableTips.length === 0) break;
                const tipIndex = Math.floor(Math.random() * availableTips.length);
                const tip = availableTips.splice(tipIndex, 1)[0];
                scrambleArr.push(tip + modifiers[Math.floor(Math.random() * modifiers.length)]);
            }
            return scrambleArr.join(" ");
        }

        function generateSkewbScramble() {
            const moves = ["U", "L", "R", "B"];
            const modifiers = ["", "'"];
            const scrambleLength = Math.floor(Math.random() * 3) + 8;
            let scrambleArr = [];
            let lastMove = '';
            for (let i = 0; i < scrambleLength; i++) {
                let move;
                do { move = moves[Math.floor(Math.random() * moves.length)]; } while (move === lastMove);
                scrambleArr.push(move + modifiers[Math.floor(Math.random() * modifiers.length)]);
                lastMove = move;
            }
            return scrambleArr.join(" ");
        }

       function generateSquare1Scramble() {
            let scrambleStr = "";
            const numSegments = Math.floor(Math.random() * 3) + 3;

            for (let seg = 0; seg < numSegments; seg++) {
                const numTwistsInSegment = Math.floor(Math.random() * 4) + 1;
                for (let i = 0; i < numTwistsInSegment; i++) {
                    let x, y;
                    do { x = Math.floor(Math.random() * 12) - 5; } while (x === 0);
                    do { y = Math.floor(Math.random() * 12) - 5; } while (y === 0);
                    scrambleStr += `(${x},${y}) `;
                }
                if (seg < numSegments - 1) {
                    scrambleStr += "/ ";
                }
            }
            return scrambleStr.trim();
        }


    function generateNewScramble(categoryToScramble) {
        currentScramble = generateScramble(categoryToScramble);
        updateScrambleDisplay();
        resetTimer();
    }

    function updateScrambleDisplay() {
        scrambleDisplay.textContent = currentScramble;
    }

    // --- STATISTICS & DATA HANDLING ---
    /**
     * Calculates an average (e.g., Ao5, Ao12) according to WCA rules.
     * @param {Array<Object>} solveEntries - Array of time entry objects.
     * @param {number} count - The number of solves to average (e.g., 5 for Ao5).
     * @returns {number|string|null} The average time, 'DNF', or null if not enough solves.
     */
    function calculateAverage(solveEntries, count) {
        if (solveEntries.length < count) return null;

        const subset = solveEntries.slice(0, count).map(entry => {
            if (entry.penalty === 'DNF') return Infinity;
            return entry.penalty === '+2' ? entry.time + 2 : entry.time;
        });

        const dnfCount = subset.filter(t => t === Infinity).length;
        if (count <= 3 && dnfCount >= 1) return 'DNF';
        if (count > 3 && dnfCount >= 2) return 'DNF';

        const sorted = [...subset].sort((a, b) => a - b);

        let trimmed = sorted;
        if (count >= 5) {
            trimmed = sorted.slice(1, -1);
        }

        const sum = trimmed.reduce((acc, t) => acc + t, 0);
        if (sum === Infinity && trimmed.length > 0) return 'DNF';

        if (trimmed.length === 0) return null;

        return sum / trimmed.length;
    }

    /**
     * Calculates the standard deviation of an array of time entries.
     * @param {Array<Object>} solveEntries - Array of time entry objects. DNFs are ignored.
     * @returns {number|null} Standard deviation or null if not enough data.
     */
    function calculateStdDev(solveEntries) {
        const validTimes = solveEntries
            .map(entry => {
                if (entry.penalty === 'DNF') return null;
                return entry.penalty === '+2' ? entry.time + 2 : entry.time;
            })
            .filter(time => time !== null);

        if (validTimes.length < 2) return null;

        const n = validTimes.length;
        const mean = validTimes.reduce((acc, val) => acc + val, 0) / n;
        const variance = validTimes.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n;
        return Math.sqrt(variance);
    }

    /**
     * Updates all statistic displays (overall and session).
     */
    function updateStats() {
        const categoryTimes = times.filter(t => t.category === currentCategory);

        if (categoryTimes.length === 0) {
            currentTimeDisplay.textContent = '-';
            bestTimeDisplay.textContent = '-';
            avg5TimeDisplay.textContent = '-';
            avg12TimeDisplay.textContent = '-';
            stdDevTimeDisplay.textContent = '-';
        } else {
            const current = categoryTimes[0];
            currentTimeDisplay.textContent = formatTimeWithPenalty(current.time, current.penalty);

            const validTimesForPB = categoryTimes
                .filter(t => t.penalty !== 'DNF')
                .map(t => (t.penalty === '+2' ? t.time + 2 : t.time));

            const bestTime = validTimesForPB.length > 0 ? Math.min(...validTimesForPB) : null;
            bestTimeDisplay.textContent = bestTime ? formatTimeDisplay(bestTime) : '-'; // Use formatter

            const currentFormattedTime = current.penalty === '+2' ? current.time + 2 : (current.penalty === 'DNF' ? Infinity : current.time);
            if (bestTime && currentFormattedTime === bestTime && current.penalty !== 'DNF') {
                bestTimeDisplay.classList.add('text-yellow-400', 'animate-pulse');
                setTimeout(() => bestTimeDisplay.classList.remove('text-yellow-400', 'animate-pulse'), 2500);
            } else {
                bestTimeDisplay.classList.remove('text-yellow-400', 'animate-pulse');
            }

            const avg5 = calculateAverage(categoryTimes, 5);
            const avg12 = calculateAverage(categoryTimes, 12);

            avg5TimeDisplay.textContent = avg5 ? (typeof avg5 === 'string' ? avg5 : formatTimeDisplay(avg5)) : '-'; // Use formatter
            avg12TimeDisplay.textContent = avg12 ? (typeof avg12 === 'string' ? avg12 : formatTimeDisplay(avg12)) : '-'; // Use formatter

            const stdDev = calculateStdDev(categoryTimes);
            stdDevTimeDisplay.textContent = stdDev ? formatTimeDisplay(stdDev) : '-'; // Use formatter
        }
        updateSessionStats();
    }

    /**
     * Updates the display of session-specific statistics.
     */
    function updateSessionStats() {
        const currentSessionCategoryTimes = sessionTimes.filter(t => t.category === currentCategory);
        sessionSolveCountDisplay.textContent = currentSessionCategoryTimes.length;

        if (currentSessionCategoryTimes.length === 0) {
            sessionBestTimeDisplay.textContent = '-';
            sessionAvg5TimeDisplay.textContent = '-';
            return;
        }

        const validSessionTimesForPB = currentSessionCategoryTimes
            .filter(t => t.penalty !== 'DNF')
            .map(t => (t.penalty === '+2' ? t.time + 2 : t.time));

        const sessionBestTime = validSessionTimesForPB.length > 0 ? Math.min(...validSessionTimesForPB) : null;
        sessionBestTimeDisplay.textContent = sessionBestTime ? formatTimeDisplay(sessionBestTime) : '-'; // Use formatter

        const sessionAvg5 = calculateAverage(currentSessionCategoryTimes, 5);
        sessionAvg5TimeDisplay.textContent = sessionAvg5 ? (typeof sessionAvg5 === 'string' ? sessionAvg5 : formatTimeDisplay(sessionAvg5)) : '-'; // Use formatter
    }

    /**
     * Formats time in seconds to a display string, including penalty.
     * @param {number} timeInSeconds - The raw time.
     * @param {string|undefined} penalty - Penalty type ('+2', 'DNF', or undefined).
     * @returns {string} Formatted time string.
     */
    function formatTimeWithPenalty(timeInSeconds, penalty) {
        if (penalty === 'DNF') return 'DNF';
        const displayTime = penalty === '+2' ? timeInSeconds + 2 : timeInSeconds;
        let formatted = formatTimeDisplay(displayTime); // Use new formatter
        if (penalty === '+2') formatted += '+';
        return formatted;
    }

    /**
     * Renders the list of times for the current category.
     */
    function renderTimesList() {
        const categoryTimesToRender = times.filter(t => t.category === currentCategory);

        if (categoryTimesToRender.length === 0) {
            timesList.innerHTML = `<div class="text-center text-gray-400 py-6"><i class="fas fa-clock text-2xl mb-2"></i><div>No hay tiempos registrados para ${getCategoryName(currentCategory)}</div></div>`;
            return;
        }

        const html = categoryTimesToRender.map((entry, index) => {
            const displayTime = formatTimeWithPenalty(entry.time, entry.penalty);
            let timeColorClass = 'text-white';
            if (entry.penalty === '+2') timeColorClass = 'text-yellow-400';
            else if (entry.penalty === 'DNF') timeColorClass = 'text-red-400';

            return `
                <div class="time-entry flex justify-between items-center p-3 border-b border-gray-700 text-sm cursor-pointer hover:bg-gray-800 rounded-lg mb-1" data-render-index="${index}">
                    <div class="flex items-center">
                        <span class="text-gray-400 mr-3 w-6 text-right">${index + 1}.</span>
                        <span class="font-mono ${timeColorClass}">${displayTime}</span>
                    </div>
                    <div class="flex items-center">
                        <div class="penalty-buttons mr-3">
                            <button class="penalty-btn text-xs px-2 py-1 rounded ${!entry.penalty ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-400'} mr-1" data-index="${index}" data-penalty="OK" aria-label="Marcar como OK">OK</button>
                            <button class="penalty-btn text-xs px-2 py-1 rounded ${entry.penalty === '+2' ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-400'} mr-1" data-index="${index}" data-penalty="+2" aria-label="Aplicar penalización +2">+2</button>
                            <button class="penalty-btn text-xs px-2 py-1 rounded ${entry.penalty === 'DNF' ? 'bg-red-600 text-white' : 'bg-gray-700 text-gray-400'}" data-index="${index}" data-penalty="DNF" aria-label="Marcar como DNF">DNF</button>
                        </div>
                        <button class="delete-btn text-red-400 hover:text-red-300 ml-2" data-index="${index}" aria-label="Borrar tiempo">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        timesList.innerHTML = html;
    }

    /**
     * Shows a modal with the scramble for a specific time entry.
     * @param {string} scrambleText - The scramble string.
     * @param {Object} timeEntryObj - The time entry object.
     */
    function showScrambleForTime(scrambleText, timeEntryObj) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4';
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
        modal.setAttribute('aria-labelledby', 'scramble-modal-title');

        const timeDisplay = formatTimeWithPenalty(timeEntryObj.time, timeEntryObj.penalty);
        const dateDisplay = new Date(timeEntryObj.date).toLocaleDateString();

        modal.innerHTML = `
            <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full border border-gray-700 shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="scramble-modal-title" class="text-xl font-semibold text-blue-400">
                        <i class="fas fa-random mr-2"></i>Scramble
                    </h3>
                    <span class="text-xs bg-gray-700 text-blue-400 px-2 py-1 rounded-full">${getCategoryName(timeEntryObj.category)}</span>
                </div>
                <div class="scramble-display bg-gray-900 p-4 rounded-lg mb-4 text-center text-base leading-relaxed whitespace-pre-wrap">${scrambleText}</div>
                <div class="flex justify-between items-center text-sm text-gray-400 mb-4">
                    <div><i class="far fa-calendar-alt mr-1"></i> ${dateDisplay}</div>
                    <div><i class="far fa-clock mr-1"></i> ${timeDisplay}</div>
                </div>
                <button class="w-full mt-2 py-2.5 btn-primary rounded-lg font-medium transition flex items-center justify-center" aria-label="Cerrar modal de scramble">
                    <i class="fas fa-times mr-2"></i>Cerrar
                </button>
            </div>
        `;

        const closeButton = modal.querySelector('button');
        closeButton.addEventListener('click', () => modal.remove());
        document.body.appendChild(modal);
        closeButton.focus();
    }

    /**
     * Applies a penalty to a time entry.
     * @param {number} renderedIndex - The index of the time in the currently rendered list for the category.
     * @param {string} penaltyValue - The penalty type ('OK', '+2', 'DNF').
     */
    function applyPenalty(renderedIndex, penaltyValue) {
        const categoryTimes = times.filter(t => t.category === currentCategory);
        const targetEntry = categoryTimes[renderedIndex];
        if (!targetEntry) return;

        const globalIndex = times.findIndex(t => t === targetEntry);

        if (globalIndex !== -1) {
            times[globalIndex].penalty = penaltyValue === 'OK' ? undefined : penaltyValue;
            localStorage.setItem('speedcube-times', JSON.stringify(times));
            updateStats();
            renderTimesList();
            updateChartData();
        }
    }

    /**
     * Deletes a time entry.
     * @param {number} renderedIndex - The index of the time in the currently rendered list for the category.
     */
    function deleteTimeEntry(renderedIndex) {
        const categoryTimes = times.filter(t => t.category === currentCategory);
        const targetEntry = categoryTimes[renderedIndex];
        if (!targetEntry) return;

        const globalIndex = times.findIndex(t => t === targetEntry);

        if (globalIndex !== -1) {
            if (confirm(`¿Estás seguro de que quieres borrar el tiempo ${formatTimeWithPenalty(times[globalIndex].time, times[globalIndex].penalty)}?`)) {
                times.splice(globalIndex, 1);

                const sessionIndexToRemove = sessionTimes.indexOf(targetEntry);
                if (sessionIndexToRemove > -1) {
                    sessionTimes.splice(sessionIndexToRemove, 1);
                }

                localStorage.setItem('speedcube-times', JSON.stringify(times));
                updateStats();
                renderTimesList();
                updateChartData();
            }
        }
    }

    /**
     * Resets all session-specific statistics.
     */
    function resetSession() {
        sessionTimes = [];
        console.log("Session reset.");
        updateSessionStats();
    }

    /**
     * Clears all times for the current category.
     */
    function clearAllTimes() {
        if (confirm(`¿Estás seguro de que quieres borrar todos los tiempos para la categoría ${getCategoryName(currentCategory)}? Esta acción no se puede deshacer.`)) {
            const categoryToClear = currentCategory;
            times = times.filter(t => t.category !== categoryToClear);
            sessionTimes = sessionTimes.filter(t => t.category !== categoryToClear);

            localStorage.setItem('speedcube-times', JSON.stringify(times));
            updateStats();
            renderTimesList();
            updateChartData();
        }
    }

    // --- CHART FUNCTIONS ---
    /**
     * Initializes the times chart.
     */
    function initTimesChart() {
        const ctx = document.getElementById('times-chart').getContext('2d');
        const categoryTimesForChart = times.filter(t => t.category === currentCategory).slice().reverse();
        const chartContainer = document.getElementById('times-chart').parentElement;

        if (categoryTimesForChart.length < 2) {
            chartContainer.style.display = 'none';
            if(timesChart) { timesChart.destroy(); timesChart = null; }
            return;
        }
        chartContainer.style.display = 'block';

        const labels = categoryTimesForChart.map((_, i) => i + 1);
        const dataPoints = categoryTimesForChart.map(t => t.penalty === 'DNF' ? null : (t.penalty === '+2' ? t.time + 2 : t.time));
        const validDataPoints = dataPoints.filter(t => t !== null);
        const bestTimeLine = validDataPoints.length > 0 ? Math.min(...validDataPoints) : null;

        if (timesChart) timesChart.destroy();

        timesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Tiempos', data: dataPoints, borderColor: primaryColor,
                    backgroundColor: hexToRgba(primaryColor, 0.1), borderWidth: 2,
                    tension: 0.3, fill: true, spanGaps: true,
                    pointBackgroundColor: primaryColor, pointBorderColor: (theme === 'dark' ? '#ffffff' : '#1e293b'),
                    pointHoverRadius: 6, pointRadius: 4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, grid: { color: (theme === 'dark' ? 'rgba(71, 85, 105, 0.3)' : 'rgba(203, 213, 225, 0.5)') }, ticks: { color: (theme === 'dark' ? '#94a3b8' : '#475569'), callback: value => typeof value === 'number' ? formatTimeDisplay(value) : value }}, // Use formatter for Y-axis
                    x: { grid: { display: false }, ticks: { color: (theme === 'dark' ? '#94a3b8' : '#475569') }}
                },
                plugins: {
                    legend: { display: true, labels: { color: (theme === 'dark' ? '#e2e8f0' : '#1e293b'), font: { size: 12 } }},
                    tooltip: {
                        backgroundColor: (theme === 'dark' ? 'rgba(15, 23, 42, 0.9)' : 'rgba(255,255,255,0.95)'),
                        titleColor: (theme === 'dark' ? '#e2e8f0' : '#0f172a'), bodyColor: (theme === 'dark' ? '#cbd5e1' : '#334155'),
                        borderColor: primaryColor, borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const originalEntry = categoryTimesForChart[context.dataIndex];
                                if (!originalEntry) return '';
                                return `Tiempo: ${formatTimeWithPenalty(originalEntry.time, originalEntry.penalty)}`; // Uses formatter via formatTimeWithPenalty
                            }
                        }
                    }
                }
            }
        });

        if (bestTimeLine !== null && timesChart.data.datasets.length === 1) {
             timesChart.data.datasets.push({
                label: 'Mejor Tiempo', data: Array(dataPoints.length).fill(bestTimeLine),
                borderColor: accentColor, borderDash: [5, 5], borderWidth: 1.5,
                fill: false, pointRadius: 0, tension: 0
            });
            timesChart.update('none');
        }
    }

    /**
     * Updates chart data when new times are added or category changes.
     */
    function updateChartData() {
        const categoryTimesForChart = times.filter(t => t.category === currentCategory).slice().reverse();
        const chartContainer = document.getElementById('times-chart').parentElement;

        if (!timesChart && categoryTimesForChart.length >=2 ) {
            initTimesChart(); return;
        }
        if (!timesChart) return;

        if (categoryTimesForChart.length < 2) {
            chartContainer.style.display = 'none';
            timesChart.destroy(); timesChart = null;
            return;
        }
        chartContainer.style.display = 'block';

        const labels = categoryTimesForChart.map((_, i) => i + 1);
        const dataPoints = categoryTimesForChart.map(t => t.penalty === 'DNF' ? null : (t.penalty === '+2' ? t.time + 2 : t.time));
        const validDataPoints = dataPoints.filter(t => t !== null);
        const bestTimeLineData = validDataPoints.length > 0 ? Math.min(...validDataPoints) : null;

        timesChart.data.labels = labels;
        timesChart.data.datasets[0].data = dataPoints;

        const bestTimeDatasetIndex = timesChart.data.datasets.findIndex(ds => ds.label === 'Mejor Tiempo');
        if (bestTimeLineData !== null) {
            const bestTimeArray = Array(dataPoints.length).fill(bestTimeLineData);
            if (bestTimeDatasetIndex > -1) {
                timesChart.data.datasets[bestTimeDatasetIndex].data = bestTimeArray;
                timesChart.data.datasets[bestTimeDatasetIndex].borderColor = accentColor;
            } else {
                timesChart.data.datasets.push({
                    label: 'Mejor Tiempo', data: bestTimeArray, borderColor: accentColor,
                    borderDash: [5, 5], borderWidth: 1.5, fill: false, pointRadius: 0, tension: 0
                });
            }
        } else if (bestTimeDatasetIndex > -1) {
            timesChart.data.datasets.splice(bestTimeDatasetIndex, 1);
        }
        timesChart.update();
    }

    /**
     * Updates chart colors based on theme and selected colors.
     */
    function updateChartColors() {
        if (!timesChart) return;

        timesChart.data.datasets[0].borderColor = primaryColor;
        timesChart.data.datasets[0].backgroundColor = hexToRgba(primaryColor, 0.1);
        timesChart.data.datasets[0].pointBackgroundColor = primaryColor;
        timesChart.data.datasets[0].pointBorderColor = (theme === 'dark' ? '#ffffff' : '#1e293b');

        const bestTimeDataset = timesChart.data.datasets.find(ds => ds.label === 'Mejor Tiempo');
        if (bestTimeDataset) bestTimeDataset.borderColor = accentColor;

        timesChart.options.scales.y.grid.color = (theme === 'dark' ? 'rgba(71, 85, 105, 0.3)' : 'rgba(203, 213, 225, 0.5)');
        timesChart.options.scales.y.ticks.color = (theme === 'dark' ? '#94a3b8' : '#475569');
        timesChart.options.scales.x.ticks.color = (theme === 'dark' ? '#94a3b8' : '#475569');
        timesChart.options.plugins.legend.labels.color = (theme === 'dark' ? '#e2e8f0' : '#1e293b');
        timesChart.options.plugins.tooltip.backgroundColor = (theme === 'dark' ? 'rgba(15, 23, 42, 0.9)' : 'rgba(255,255,255,0.95)');
        timesChart.options.plugins.tooltip.titleColor = (theme === 'dark' ? '#e2e8f0' : '#0f172a');
        timesChart.options.plugins.tooltip.bodyColor = (theme === 'dark' ? '#cbd5e1' : '#334155');
        timesChart.options.plugins.tooltip.borderColor = primaryColor;
        timesChart.update('none');
    }


    // --- UTILITY FUNCTIONS ---
    /**
     * Shows a temporary alert for new personal bests.
     * @param {number} timeValue - The new personal best time.
     */
    function showPBAlert(timeValue) {
        const alertEl = document.createElement('div');
        alertEl.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-400 to-yellow-500 text-black px-6 py-3 rounded-full shadow-xl z-[1000] pb-alert flex items-center';
        alertEl.innerHTML = `<i class="fas fa-trophy mr-3 text-xl text-yellow-700"></i><span class="font-bold">¡NUEVO RÉCORD! ${formatTimeDisplay(timeValue)}</span>`; // Use formatter
        document.body.appendChild(alertEl);

        setTimeout(() => {
            alertEl.classList.remove('pb-alert');
            alertEl.style.transition = 'opacity 0.5s ease-out';
            alertEl.style.opacity = '0';
            setTimeout(() => alertEl.remove(), 500);
        }, 3000);
    }

    /**
     * Gets the display name for a category code.
     * @param {string} categoryCode - The category code (e.g., '333').
     * @returns {string} The display name (e.g., '3x3x3').
     */
    function getCategoryName(categoryCode) {
        const names = {
            '333': '3x3x3', '222': '2x2x2', '444': '4x4x4', '555': '5x5x5',
            '666': '6x6x6', '777': '7x7x7', '333bf': '3x3x3 BLD', '333fm': '3x3x3 FM',
            '333oh': '3x3x3 OH', 'clock': 'Clock', 'minx': 'Megaminx', 'pyram': 'Pyraminx',
            'skewb': 'Skewb', 'sq1': 'Square-1', '444bf': '4x4x4 BLD', '555bf': '5x5x5 BLD',
            '333mbf': '3x3x3 MBLD'
        };
        return names[categoryCode] || categoryCode;
    }
});
</script>
</body>
</html>